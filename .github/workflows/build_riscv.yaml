## If you need nodejs for running latest github actions pipeline, you can get nodejs for RISC-V here: https://github.com/alitariq4589/nodejs-riscv/releases ##

name: Build RISC-V runner

on:
  push:
    branches:
      - main_riscv
    tags:
      - '*_riscv'
  workflow_dispatch:

jobs:
  build:
    runs-on: RISCV64
    
    outputs:
      version-number: ${{ steps.check-version.outputs.runner_version }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Patch dev.sh for RISC-V support
      run: |
        cd src
        # Add linux-riscv64 to the supported runtime IDs list
        sed -i 's/("$RUNTIME_ID" != '\''linux-arm'\'')/("$RUNTIME_ID" != '\''linux-arm'\'') \&\& ("$RUNTIME_ID" != '\''linux-riscv64'\'')/' dev.sh
        
        # Also add riscv64 detection in the CPU detection section (around line 45-50)
        sed -i '/aarch64) RUNTIME_ID="linux-arm64";;/a\            riscv64) RUNTIME_ID="linux-riscv64";;' dev.sh
        
        echo "=== Verifying dev.sh patches ==="
        grep -A 2 "linux-riscv64" dev.sh || echo "Warning: RISC-V support might not be fully patched"
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y liblttng-ust-dev libkrb5-dev zlib1g-dev libicu-dev \
          libssl-dev libcurl4-openssl-dev libelf-dev libunwind-dev pkg-config wget tar libatomic1
    
    - name: Download .NET 10.0.102 SDK
      run: |
        cd $HOME
        # Download the official RISC-V .NET 10 SDK (glibc variant)
        wget -q -O dotnet.tar.gz https://github.com/filipnavara/dotnet-riscv/releases/download/10.0.102/dotnet-sdk-10.0.102-linux-riscv64.tar.gz
        
        # Extract to versioned directory
        mkdir -p _dotnetsdk/10.0.102
        tar -xf dotnet.tar.gz -C _dotnetsdk/10.0.102
        
        # Add to PATH and set DOTNET_ROOT
        echo "$HOME/_dotnetsdk/10.0.102" >> $GITHUB_PATH
        echo "DOTNET_ROOT=$HOME/_dotnetsdk/10.0.102" >> $GITHUB_ENV

    - name: Verify .NET installation
      run: |
        echo "=== .NET Info ==="
        dotnet --info
        echo ""
        echo "=== .NET Version ==="
        dotnet --version
        echo ""
        echo "=== Available Runtimes ==="
        dotnet --list-runtimes
        echo ""
        echo "=== Available SDKs ==="
        dotnet --list-sdks

    - name: Restore and Build
      run: |
        cd src
        ./dev.sh layout Release linux-riscv64

    - name: Package
      run: |
        cd src
        ./dev.sh package Release linux-riscv64
    
    - name: Check Version
      id: check-version
      run: |
        RUNNER_VERSION=$(./_layout/bin/Runner.Listener --version)
        echo "The Github runner version is $RUNNER_VERSION"
        echo "runner_version=$RUNNER_VERSION" >> $GITHUB_OUTPUT

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: actions-runner-linux-riscv64-${{ steps.check-version.outputs.runner_version }}
        path: "_package/actions-runner-linux-riscv64-*.tar.gz"

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: actions-runner-linux-riscv64-${{ needs.build.outputs.version-number }}
          path: _package

      - name: Get filename of the package
        id: get_filename
        run: |
          filename=$(basename $(ls -1 _package/actions-runner-linux-riscv64-*.tar.gz))
          echo "filename=$filename" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: "_package/${{ steps.get_filename.outputs.filename }}"
          asset_name: ${{ steps.get_filename.outputs.filename }}
          asset_content_type: application/gzip