name: Build RISC-V runner (Native Binaries)

on:
  push:
    branches:
      - riscv_dotnet10_build
  workflow_dispatch:

jobs:
  build:
    runs-on: RISCV64
    permissions:
      contents: write
    
    outputs:
      version-number: ${{ steps.check-version.outputs.runner_version }}
      tag-name: ${{ steps.set-tag.outputs.tag_name }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y liblttng-ust-dev libkrb5-dev zlib1g-dev libicu-dev \
          libssl-dev libcurl4-openssl-dev libelf-dev libunwind-dev pkg-config wget tar libatomic1
    
    - name: Download and setup .NET 10.0.102 SDK
      run: |
        # Download the RISC-V .NET 10 SDK
        wget -q -O dotnet.tar.gz https://github.com/filipnavara/dotnet-riscv/releases/download/10.0.102/dotnet-sdk-10.0.102-linux-riscv64.tar.gz
        
        # Extract to the location dev.sh expects
        mkdir -p _dotnetsdk/10.0.102
        tar -xf dotnet.tar.gz -C _dotnetsdk/10.0.102
        
        # Create the marker file that dev.sh checks for
        echo "10.0.102" > _dotnetsdk/10.0.102/.10.0.102
        
        # Also set it up in PATH
        echo "$PWD/_dotnetsdk/10.0.102" >> $GITHUB_PATH
        echo "DOTNET_ROOT=$PWD/_dotnetsdk/10.0.102" >> $GITHUB_ENV

    - name: Check for global.json and update if needed
      run: |
        echo "=== Checking for global.json files ==="
        find . -name "global.json" -type f
        
        # Update any global.json files to use .NET 10
        for json_file in $(find . -name "global.json" -type f); do
          echo "Found: $json_file"
          cat "$json_file"
          
          if grep -q "sdk" "$json_file"; then
            echo "Updating $json_file to use .NET 10.0.102"
            sed -i 's/"version".*:.*"[0-9].*"/"version": "10.0.102"/g' "$json_file"
            echo "Updated content:"
            cat "$json_file"
          fi
        done

    - name: Patch dev.sh for RISC-V and .NET 10
      run: |
        cd src
        
        # 1. Update .NET SDK version to 10.0.102
        sed -i 's/DOTNETSDK_VERSION="8.0.417"/DOTNETSDK_VERSION="10.0.102"/' dev.sh
        
        # 2. Add linux-riscv64 to supported platforms
        sed -i 's/("$RUNTIME_ID" != '\''linux-arm'\'')/("$RUNTIME_ID" != '\''linux-arm'\'') \&\& ("$RUNTIME_ID" != '\''linux-riscv64'\'')/' dev.sh
        
        # 3. Add riscv64 CPU detection
        sed -i '/aarch64) RUNTIME_ID="linux-arm64";;/a\            riscv64) RUNTIME_ID="linux-riscv64";;' dev.sh

    - name: Add linux-riscv64 to RuntimeIdentifiers in all project files
      run: |
        echo "=== Adding linux-riscv64 to RuntimeIdentifiers ==="
        
        # Find all .csproj files and add linux-riscv64 to RuntimeIdentifiers
        find src -name "*.csproj" -type f | while read csproj; do
          echo "Processing: $csproj"
          
          # Check if file has RuntimeIdentifiers tag
          if grep -q "<RuntimeIdentifiers>" "$csproj"; then
            # Add linux-riscv64 to the RuntimeIdentifiers list if not already present
            if ! grep "<RuntimeIdentifiers>" "$csproj" | grep -q "linux-riscv64"; then
              sed -i 's/<RuntimeIdentifiers>\(.*\)<\/RuntimeIdentifiers>/<RuntimeIdentifiers>\1;linux-riscv64<\/RuntimeIdentifiers>/' "$csproj"
              echo "  âœ“ Added linux-riscv64 to RuntimeIdentifiers"
              grep "RuntimeIdentifiers" "$csproj"
            else
              echo "  - Already contains linux-riscv64"
            fi
          else
            echo "  - No RuntimeIdentifiers found"
          fi
        done

    - name: Configure for Native Binary Build (like official)
      run: |
        echo "=== Configuring Native Binary Build ==="
        
        for proj in "Runner.Listener" "Runner.Worker" "Runner.PluginHost"; do
          csproj="src/$proj/$proj.csproj"
          if [ -f "$csproj" ]; then
            echo "Processing: $csproj"
            
            # Ensure SelfContained is true (bundles runtime)
            if grep -q "<SelfContained>" "$csproj"; then
              sed -i 's/<SelfContained>false<\/SelfContained>/<SelfContained>true<\/SelfContained>/g' "$csproj"
            fi
            
            # IMPORTANT: Remove UseAppHost=false or set to true for native binaries
            # If UseAppHost exists and is false, remove it (will default to true)
            if grep -q "<UseAppHost>false</UseAppHost>" "$csproj"; then
              sed -i '/<UseAppHost>false<\/UseAppHost>/d' "$csproj"
              echo "  âœ“ Removed UseAppHost=false (will default to true for native binary)"
            elif grep -q "<UseAppHost>" "$csproj"; then
              # If it exists with another value, set to true
              sed -i 's/<UseAppHost>.*<\/UseAppHost>/<UseAppHost>true<\/UseAppHost>/' "$csproj"
              echo "  âœ“ Set UseAppHost=true for native binary"
            fi
            
            echo "  âœ“ Configured: SelfContained=true, UseAppHost=true (default)"
            
            # Verify changes
            echo "  Configuration:"
            grep -E "UseAppHost|SelfContained" "$csproj" | head -5 || echo "  (UseAppHost not explicitly set - will use default=true)"
          fi
        done

    - name: Verify .NET installation
      run: |
        echo "=== .NET Info ==="
        dotnet --info
        echo ""
        echo "=== Checking for AppHost support ==="
        # Check if the SDK has apphost for riscv64
        if [ -f "_dotnetsdk/10.0.102/packs/Microsoft.NETCore.App.Host.linux-riscv64" ]; then
          echo "âœ“ AppHost pack found for linux-riscv64"
        else
          echo "âš  AppHost pack might not be available - checking SDK structure..."
          find _dotnetsdk/10.0.102 -name "*Host*" -o -name "*apphost*" | head -20
        fi

    - name: Restore and Build
      run: |
        cd src
        echo "=== Building with Native Binary Configuration ==="
        ./dev.sh layout Release linux-riscv64

    - name: Verify Native Binary Output
      run: |
        echo "=== Checking for Native Binaries ==="
        
        for binary in "Runner.Listener" "Runner.Worker" "Runner.PluginHost"; do
          if [ -f "_layout/bin/$binary" ]; then
            echo "âœ“ Found: $binary"
            file "_layout/bin/$binary"
            ls -lh "_layout/bin/$binary"
            
            # Check if it's an ELF executable (native binary)
            if file "_layout/bin/$binary" | grep -q "ELF.*executable"; then
              echo "  âœ… SUCCESS: $binary is a native ELF binary!"
            elif file "_layout/bin/$binary" | grep -q "script"; then
              echo "  âš  WARNING: $binary is a script, not a native binary"
            else
              echo "  âŒ ERROR: $binary type unknown"
              file "_layout/bin/$binary"
            fi
          else
            echo "âœ— Missing: $binary"
            # Check for .dll version
            if [ -f "_layout/bin/$binary.dll" ]; then
              echo "  âŒ Found $binary.dll instead - AppHost failed!"
              echo "  This means UseAppHost=true didn't work on RISC-V"
            fi
          fi
        done
        
        echo ""
        echo "=== Layout Directory Contents ==="
        ls -lah _layout/bin/ | head -30
        
        echo ""
        echo "=== Checking for Runtime Files ==="
        if [ -d "_layout/bin" ]; then
          echo "Shared libraries:"
          ls _layout/bin/*.so 2>/dev/null | head -10 || echo "No .so files found"
        fi

    - name: Test Native Binary Execution
      run: |
        echo "=== Testing Native Binary ==="
        if [ -x "_layout/bin/Runner.Listener" ]; then
          echo "Testing Runner.Listener..."
          _layout/bin/Runner.Listener --version || echo "Execution failed - may need runtime libraries"
        else
          echo "âŒ Runner.Listener is not executable or doesn't exist"
          exit 1
        fi

    - name: Package
      run: |
        cd src
        ./dev.sh package Release linux-riscv64
    
    - name: Check Version
      id: check-version
      run: |
        # Try to run the native binary directly
        RUNNER_VERSION=$(_layout/bin/Runner.Listener --version 2>/dev/null || cat src/runnerversion)
        echo "The Github runner version is $RUNNER_VERSION"
        echo "runner_version=$RUNNER_VERSION" >> $GITHUB_OUTPUT

    - name: Set tag name
      id: set-tag
      run: |
        TAG_NAME="v${{ steps.check-version.outputs.runner_version }}-riscv64-native"
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: actions-runner-linux-riscv64-${{ steps.check-version.outputs.runner_version }}-native
        path: "_package/actions-runner-linux-riscv64-*.tar.gz"

    - name: Create or verify tag
      run: |
        TAG="${{ steps.set-tag.outputs.tag_name }}"

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
          echo "âœ… Tag $TAG already exists. Will update release if needed." 
        else
          echo "ðŸ†• Tag $TAG does not exist. Creating and pushing..."
          git tag "$TAG"
          git push origin "$TAG"
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.set-tag.outputs.tag_name }}
        name: "GitHub Actions Runner ${{ steps.check-version.outputs.runner_version }} for RISC-V (Native Binary)"
        body: |
          # GitHub Actions Runner for RISC-V - Native Binary Build
          
          **Version:** ${{ steps.check-version.outputs.runner_version }}
          **Architecture:** linux-riscv64
          **Build Type:** Native ELF Executables (like official builds)
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          
          ## âœ… True Native Binaries - Built Like Official Repository
          
          This build produces **native ELF executables** identical to the official GitHub Actions runner:
          
          - âœ… Native binary executables (`Runner.Listener`, `Runner.Worker`, `Runner.PluginHost`)
          - âœ… Self-contained with bundled .NET 10 runtime
          - âœ… No wrapper scripts needed
          - âœ… Identical structure to official x64/arm64 builds
          
          ### Installation
          ```bash
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.set-tag.outputs.tag_name }}/actions-runner-linux-riscv64-${{ steps.check-version.outputs.runner_version }}.tar.gz
          mkdir actions-runner && cd actions-runner
          tar xzf ../actions-runner-linux-riscv64-${{ steps.check-version.outputs.runner_version }}.tar.gz
          
          # Configure
          ./config.sh --url https://github.com/YOUR-ORG/YOUR-REPO --token YOUR-TOKEN
          
          # Run
          ./run.sh
          ```
          
          ### System Requirements
          
          - RISC-V 64-bit processor
          - Linux operating system
          - Standard system libraries (glibc, libssl, libicu, etc.)
          - **No .NET runtime installation required** âœ…
          
          ### Technical Details
          
          - **Deployment Type:** Self-Contained
          - **UseAppHost:** true (native ELF binaries)
          - **SelfContained:** true (bundled runtime)
          - **Runtime:** .NET 10.0.102 (RISC-V port)
          - **Target Framework:** net8.0
          - **Runtime Identifier:** linux-riscv64
          
          ### File Structure
          
          ```
          actions-runner/
          â”œâ”€â”€ bin/
          â”‚   â”œâ”€â”€ Runner.Listener          # Native ELF executable
          â”‚   â”œâ”€â”€ Runner.Worker            # Native ELF executable
          â”‚   â”œâ”€â”€ Runner.PluginHost        # Native ELF executable
          â”‚   â”œâ”€â”€ *.so                     # Runtime libraries
          â”‚   â””â”€â”€ (bundled .NET runtime)
          â”œâ”€â”€ config.sh
          â”œâ”€â”€ run.sh
          â””â”€â”€ ...
          ```
          
          ### Comparison to Official Build
          
          | Feature | Official Build | This RISC-V Build |
          |---------|---------------|-------------------|
          | Binary Type | Native ELF | Native ELF âœ… |
          | Runtime Bundled | Yes | Yes âœ… |
          | Wrapper Scripts | No | No âœ… |
          | Self-Contained | Yes | Yes âœ… |
          | Installation Required | None | None âœ… |
          
          ### Credits
          
          - Original GitHub Actions Runner: https://github.com/actions/runner
          - .NET RISC-V Port: https://github.com/filipnavara/dotnet-riscv
        files: _package/actions-runner-linux-riscv64-*.tar.gz
        draft: false
        prerelease: false
        fail_on_unmatched_files: true