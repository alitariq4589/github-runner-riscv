## If you need nodejs for running latest github actions pipeline, you can get nodejs for RISC-V here: 
## https://github.com/alitariq4589/nodejs-riscv/releases
## Latest: https://github.com/alitariq4589/nodejs-riscv/releases/download/v24.7.0/nodejs-24.7.0-riscv64-linux.tar.gz

name: Build RISC-V runner

on:
  push:
    branches:
      - riscv_dotnet10
    tags:
      - '*_riscv'
  workflow_dispatch:

jobs:
  build:
    runs-on: RISCV64
    
    outputs:
      version-number: ${{ steps.check-version.outputs.runner_version }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y liblttng-ust-dev libkrb5-dev zlib1g-dev libicu-dev \
          libssl-dev libcurl4-openssl-dev libelf-dev libunwind-dev pkg-config wget tar libatomic1
    
    - name: Download and setup .NET 10.0.102 SDK
      run: |
        # Download the RISC-V .NET 10 SDK
        wget -q -O dotnet.tar.gz https://github.com/filipnavara/dotnet-riscv/releases/download/10.0.102/dotnet-sdk-10.0.102-linux-riscv64.tar.gz
        
        # Extract to the location dev.sh expects
        mkdir -p _dotnetsdk/10.0.102
        tar -xf dotnet.tar.gz -C _dotnetsdk/10.0.102
        
        # Create the marker file that dev.sh checks for
        echo "10.0.102" > _dotnetsdk/10.0.102/.10.0.102
        
        # Also set it up in PATH
        echo "$PWD/_dotnetsdk/10.0.102" >> $GITHUB_PATH
        echo "DOTNET_ROOT=$PWD/_dotnetsdk/10.0.102" >> $GITHUB_ENV

    - name: Investigate SDK contents for RISC-V support
      run: |
        echo "=== Checking for RISC-V runtime packs ==="
        find _dotnetsdk/10.0.102 -name "*riscv64*" -o -name "*linux-riscv64*" | head -20
        
        echo ""
        echo "=== Checking packs directory ==="
        ls -la _dotnetsdk/10.0.102/packs/ || echo "No packs directory"
        
        echo ""
        echo "=== Checking shared directory ==="
        ls -la _dotnetsdk/10.0.102/shared/ || echo "No shared directory"
        
        echo ""
        echo "=== Checking for apphost ==="
        find _dotnetsdk/10.0.102 -name "apphost" -o -name "apphost.exe" | head -10

    - name: Check for global.json and update if needed
      run: |
        echo "=== Checking for global.json files ==="
        find . -name "global.json" -type f
        
        # Update any global.json files to use .NET 10
        for json_file in $(find . -name "global.json" -type f); do
          echo "Found: $json_file"
          cat "$json_file"
          
          # Update SDK version to 10.0.102 (or just remove version constraint)
          if grep -q "sdk" "$json_file"; then
            echo "Updating $json_file to use .NET 10.0.102"
            sed -i 's/"version".*:.*"[0-9].*"/"version": "10.0.102"/g' "$json_file"
            echo "Updated content:"
            cat "$json_file"
          fi
        done

    - name: Patch dev.sh for RISC-V and .NET 10
      run: |
        cd src
        
        # 1. Update .NET SDK version to 10.0.102
        sed -i 's/DOTNETSDK_VERSION="8.0.415"/DOTNETSDK_VERSION="10.0.102"/' dev.sh
        
        # 2. Add linux-riscv64 to supported platforms
        sed -i 's/("$RUNTIME_ID" != '\''linux-arm'\'')/("$RUNTIME_ID" != '\''linux-arm'\'') \&\& ("$RUNTIME_ID" != '\''linux-riscv64'\'')/' dev.sh
        
        # 3. Add riscv64 CPU detection
        sed -i '/aarch64) RUNTIME_ID="linux-arm64";;/a\            riscv64) RUNTIME_ID="linux-riscv64";;' dev.sh

    - name: Patch project files to disable UseAppHost for RISC-V
      run: |
        echo "=== Patching Runner.Listener.csproj ==="
        
        # Add UseAppHost=false for RISC-V builds to work around missing apphost
        # This creates a dotnet-runnable assembly instead of a native executable
        cd src/Runner.Listener
        
        # Check if already has UseAppHost
        if grep -q "UseAppHost" Runner.Listener.csproj; then
          echo "UseAppHost already configured"
        else
          # Add UseAppHost condition for RISC-V
          sed -i '/<PropertyGroup>/a\    <UseAppHost Condition="'\''$(PackageRuntime)'\'' == '\''linux-riscv64'\''">false</UseAppHost>' Runner.Listener.csproj
        fi
        
        echo "Updated Runner.Listener.csproj:"
        grep -A 5 -B 5 "UseAppHost" Runner.Listener.csproj || echo "No UseAppHost found"
        
        cd ../..
        
        # Do the same for Runner.Worker and Runner.PluginHost
        for proj in "Runner.Worker" "Runner.PluginHost"; do
          if [ -f "src/$proj/$proj.csproj" ]; then
            echo "=== Patching $proj.csproj ==="
            cd "src/$proj"
            if ! grep -q "UseAppHost" "$proj.csproj"; then
              sed -i '/<PropertyGroup>/a\    <UseAppHost Condition="'\''$(PackageRuntime)'\'' == '\''linux-riscv64'\''">false</UseAppHost>' "$proj.csproj"
            fi
            cd ../..
          fi
        done

    - name: Verify .NET installation
      run: |
        echo "=== .NET Info ==="
        dotnet --info
        echo ""
        echo "=== .NET Version ==="
        dotnet --version

    - name: Restore and Build
      run: |
        cd src
        ./dev.sh layout Release linux-riscv64

    - name: Package
      run: |
        cd src
        ./dev.sh package Release linux-riscv64
    
    - name: Check Version
      id: check-version
      run: |
        RUNNER_VERSION=$(./_layout/bin/Runner.Listener --version)
        echo "The Github runner version is $RUNNER_VERSION"
        echo "runner_version=$RUNNER_VERSION" >> $GITHUB_OUTPUT

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: actions-runner-linux-riscv64-${{ steps.check-version.outputs.runner_version }}
        path: "_package/actions-runner-linux-riscv64-*.tar.gz"

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: actions-runner-linux-riscv64-${{ needs.build.outputs.version-number }}
          path: _package

      - name: Get filename of the package
        id: get_filename
        run: |
          filename=$(basename $(ls -1 _package/actions-runner-linux-riscv64-*.tar.gz))
          echo "filename=$filename" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: "_package/${{ steps.get_filename.outputs.filename }}"
          asset_name: ${{ steps.get_filename.outputs.filename }}
          asset_content_type: application/gzip